"""
Amazon API Entegrasyon Mod√ºl√º
============================

Bu mod√ºl, Rainforest API kullanarak Amazon'dan √ºr√ºn bilgilerini √ßeker.
Mevcut SwipeStyle sistemini Amazon √ºr√ºnleriyle entegre eder.

√ñzellikler:
- Amazon √ºr√ºn arama
- √úr√ºn detaylarƒ± √ßekme
- Fiyat ve stok bilgisi
- Kullanƒ±cƒ± yorumlarƒ±
- Fiyat kar≈üƒ±la≈ütƒ±rma

Gereksinimler:
- Rainforest API anahtarƒ± (RAINFOREST_API_KEY)
- requests k√ºt√ºphanesi

Kullanƒ±m:
    from app.amazon_api import AmazonAPI
    
    api = AmazonAPI()
    products = api.search_products("laptop", max_results=10)
    product_details = api.get_product_details("B08N5WRWNW")
"""

import os
import requests
import json
from typing import Dict, List, Optional
from datetime import datetime

class AmazonAPI:
    """
    Amazon API entegrasyonu i√ßin ana sƒ±nƒ±f.
    Rainforest API kullanarak Amazon'dan √ºr√ºn bilgilerini √ßeker.
    """
    
    def __init__(self):
        """
        Amazon API sƒ±nƒ±fƒ±nƒ± ba≈ülatƒ±r.
        API anahtarƒ±nƒ± environment variable'dan alƒ±r.
        """
        self.api_key = os.getenv('RAINFOREST_API_KEY')
        if not self.api_key:
            print("‚ö†Ô∏è  RAINFOREST_API_KEY environment variable'ƒ± bulunamadƒ±!")
            print("   Rainforest API'den √ºcretsiz anahtar alabilirsiniz: https://www.rainforestapi.com/")
        
        self.base_url = "https://api.rainforestapi.com/request"
        self.country = "tr"  # T√ºrkiye i√ßin
        self.currency = "TRY"
    
    def search_products(self, query: str, max_results: int = 10, 
                       min_price: Optional[float] = None, 
                       max_price: Optional[float] = None,
                       category: Optional[str] = None) -> List[Dict]:
        """
        Amazon'da √ºr√ºn arama yapar.
        
        Args:
            query (str): Arama sorgusu
            max_results (int): Maksimum sonu√ß sayƒ±sƒ± (varsayƒ±lan: 10)
            min_price (float): Minimum fiyat filtresi
            max_price (float): Maksimum fiyat filtresi
            category (str): Kategori filtresi
            
        Returns:
            List[Dict]: √úr√ºn listesi
        """
        if not self.api_key:
            return self._get_mock_products(query, max_results)
        
        try:
            params = {
                'api_key': self.api_key,
                'type': 'search',
                'amazon_domain': 'amazon.com.tr',
                'search_term': query,
                'max_page': 1
            }
            
            if min_price:
                params['min_price'] = int(min_price)
            if max_price:
                params['max_price'] = int(max_price)
            
            print(f"üîç Amazon'da aranƒ±yor: {query}")
            response = requests.get(self.base_url, params=params)
            
            if response.status_code == 200:
                data = response.json()
                products = data.get('search_results', [])
                
                # √úr√ºnleri formatla
                formatted_products = []
                for product in products[:max_results]:
                    formatted_product = self._format_product(product)
                    formatted_products.append(formatted_product)
                
                print(f"‚úÖ {len(formatted_products)} √ºr√ºn bulundu")
                return formatted_products
            else:
                print(f"‚ùå API hatasƒ±: {response.status_code}")
                return self._get_mock_products(query, max_results)
                
        except Exception as e:
            print(f"‚ùå Amazon API hatasƒ±: {e}")
            return self._get_mock_products(query, max_results)
    
    def get_product_details(self, asin: str) -> Optional[Dict]:
        """
        Belirli bir √ºr√ºn√ºn detaylarƒ±nƒ± √ßeker.
        
        Args:
            asin (str): Amazon ASIN kodu
            
        Returns:
            Dict: √úr√ºn detaylarƒ±
        """
        if not self.api_key:
            return self._get_mock_product_details(asin)
        
        try:
            params = {
                'api_key': self.api_key,
                'type': 'product',
                'amazon_domain': 'amazon.com.tr',
                'asin': asin
            }
            
            print(f"üì¶ √úr√ºn detaylarƒ± √ßekiliyor: {asin}")
            response = requests.get(self.base_url, params=params)
            
            if response.status_code == 200:
                data = response.json()
                product = data.get('product', {})
                return self._format_product_details(product)
            else:
                print(f"‚ùå √úr√ºn detay hatasƒ±: {response.status_code}")
                return self._get_mock_product_details(asin)
                
        except Exception as e:
            print(f"‚ùå √úr√ºn detay API hatasƒ±: {e}")
            return self._get_mock_product_details(asin)
    
    def get_price_history(self, asin: str) -> List[Dict]:
        """
        √úr√ºn√ºn fiyat ge√ßmi≈üini √ßeker.
        
        Args:
            asin (str): Amazon ASIN kodu
            
        Returns:
            List[Dict]: Fiyat ge√ßmi≈üi
        """
        # Rainforest API'nin fiyat ge√ßmi≈üi √∂zelliƒüi yok
        # Bu √∂zellik i√ßin ayrƒ± bir servis gerekebilir
        return []
    
    def _format_product(self, product: Dict) -> Dict:
        """
        Amazon API'den gelen √ºr√ºn verisini formatlar.
        
        Args:
            product (Dict): Ham √ºr√ºn verisi
            
        Returns:
            Dict: Formatlanmƒ±≈ü √ºr√ºn verisi
        """
        try:
            return {
                'asin': product.get('asin', ''),
                'title': product.get('title', ''),
                'price': {
                    'current': product.get('price', {}).get('value', 0),
                    'currency': product.get('price', {}).get('currency', 'TRY'),
                    'original': product.get('price', {}).get('original_value', 0)
                },
                'rating': product.get('rating', 0),
                'reviews_count': product.get('ratings_total', 0),
                'image': product.get('image', ''),
                'url': product.get('link', ''),
                'availability': product.get('availability', ''),
                'prime': product.get('is_prime', False),
                'sponsored': product.get('sponsored', False),
                'features': product.get('features', []),
                'categories': product.get('categories', [])
            }
        except Exception as e:
            print(f"‚ùå √úr√ºn formatlama hatasƒ±: {e}")
            return {}
    
    def _format_product_details(self, product: Dict) -> Dict:
        """
        √úr√ºn detaylarƒ±nƒ± formatlar.
        
        Args:
            product (Dict): Ham √ºr√ºn detay verisi
            
        Returns:
            Dict: Formatlanmƒ±≈ü √ºr√ºn detaylarƒ±
        """
        try:
            return {
                'asin': product.get('asin', ''),
                'title': product.get('title', ''),
                'description': product.get('description', ''),
                'price': {
                    'current': product.get('price', {}).get('value', 0),
                    'currency': product.get('price', {}).get('currency', 'TRY'),
                    'original': product.get('price', {}).get('original_value', 0)
                },
                'rating': product.get('rating', 0),
                'reviews_count': product.get('ratings_total', 0),
                'images': product.get('images', []),
                'url': product.get('link', ''),
                'availability': product.get('availability', ''),
                'prime': product.get('is_prime', False),
                'features': product.get('features', []),
                'specifications': product.get('specifications', []),
                'reviews': product.get('reviews', []),
                'variants': product.get('variants', []),
                'categories': product.get('categories', [])
            }
        except Exception as e:
            print(f"‚ùå √úr√ºn detay formatlama hatasƒ±: {e}")
            return {}
    
    def _get_mock_products(self, query: str, max_results: int) -> List[Dict]:
        """
        API anahtarƒ± yoksa mock √ºr√ºnler d√∂nd√ºr√ºr.
        
        Args:
            query (str): Arama sorgusu
            max_results (int): Maksimum sonu√ß sayƒ±sƒ±
            
        Returns:
            List[Dict]: Mock √ºr√ºn listesi
        """
        print(f"üîÑ Mock √ºr√ºnler olu≈üturuluyor: {query}")
        
        # Kategori bazlƒ± ger√ßek√ßi √ºr√ºn adlarƒ±
        product_names = {
            'mouse': [
                'Logitech G203 Lightsync Gaming Mouse',
                'Razer DeathAdder V2 Gaming Mouse',
                'SteelSeries Rival 3 Gaming Mouse',
                'Corsair M65 RGB Elite Gaming Mouse',
                'HyperX Pulsefire Haste Gaming Mouse'
            ],
            'klavye': [
                'Logitech G Pro X Mechanical Gaming Keyboard',
                'Razer BlackWidow V3 Pro Wireless Keyboard',
                'SteelSeries Apex Pro TKL Gaming Keyboard',
                'Corsair K100 RGB Mechanical Keyboard',
                'HyperX Alloy Origins Core Gaming Keyboard'
            ],
                         'kulaklƒ±k': [
                 'Anker Soundcore Liberty 4 NC',
                 'Sony WF-C700N',
                 'Samsung Galaxy Buds FE',
                 'Huawei FreeBuds 5i',
                 'JBL Live Pro 2 TWS'
             ],
            'laptop': [
                'ASUS ROG Strix G15 Gaming Laptop',
                'MSI GE76 Raider Gaming Laptop',
                'Lenovo Legion 5 Pro Gaming Laptop',
                'Acer Predator Helios 300 Gaming Laptop',
                'HP Omen 15 Gaming Laptop'
            ],
            'telefon': [
                'iPhone 15 Pro Max 256GB',
                'Samsung Galaxy S24 Ultra 256GB',
                'Google Pixel 8 Pro 256GB',
                'OnePlus 12 256GB',
                'Xiaomi 14 Pro 256GB'
            ]
        }
        
        # Query'ye g√∂re √ºr√ºn adlarƒ±nƒ± se√ß
        query_lower = query.lower()
        names = product_names.get(query_lower, [f'Premium {query.title()} {i+1}' for i in range(5)])
        
        # Ger√ßek√ßi fiyatlar - 1.5k-3k aralƒ±ƒüƒ±nda daha fazla √ºr√ºn
        base_prices = {
            'mouse': [150, 250, 350, 450, 550],
            'klavye': [800, 1200, 1800, 2500, 3500],
            'kulaklƒ±k': [1600, 2200, 2800, 3500, 4200],  # 1.5k-3k aralƒ±ƒüƒ±nda
            'laptop': [15000, 25000, 35000, 45000, 55000],
            'telefon': [25000, 35000, 45000, 55000, 65000]
        }
        
        prices = base_prices.get(query_lower, [100 + (i * 50) for i in range(5)])
        
        mock_products = []
        for i in range(min(max_results, 5)):
            current_price = prices[i] if i < len(prices) else 100 + (i * 50)
            original_price = int(current_price * 1.3)  # %30 indirim
            
            # Fiyat filtresi uygula (1.5k-3k aralƒ±ƒüƒ± i√ßin)
            if query_lower == 'kulaklƒ±k' and (current_price < 1500 or current_price > 3000):
                continue
            
            mock_products.append({
                'asin': f'B0{query_lower[:3].upper()}{i:06d}',
                'title': names[i] if i < len(names) else f'Premium {query.title()} {i+1}',
                'price': {
                    'current': current_price,
                    'currency': 'TRY',
                    'original': original_price
                },
                'rating': 4.2 + (i * 0.1),
                'reviews_count': 150 + (i * 75),
                'image': self._get_product_image(query_lower, i),
                                 'url': self._get_search_url(query_lower, i),
                'availability': 'Stokta',
                'prime': True,
                'sponsored': i == 0,  # ƒ∞lk √ºr√ºn reklam
                'features': [
                    'Y√ºksek performans',
                    'Dayanƒ±klƒ± tasarƒ±m',
                    'Kolay kullanƒ±m'
                ],
                'categories': ['Elektronik', query.title()]
            })
        
        return mock_products
    
    def _get_product_image(self, category: str, index: int) -> str:
         """
         Kategori bazlƒ± ger√ßek√ßi √ºr√ºn g√∂rselleri d√∂nd√ºr√ºr.
         
         Args:
             category (str): √úr√ºn kategorisi
             index (int): √úr√ºn indeksi
             
         Returns:
             str: √úr√ºn g√∂rseli URL'i
         """
         # Kategori bazlƒ± g√∂rsel URL'leri
         product_images = {
             'mouse': [
                 'https://images.unsplash.com/photo-1527864550417-7fd91fc51a46?w=300&h=300&fit=crop',
                 'https://images.unsplash.com/photo-1615663245857-ac93bb7c39e7?w=300&h=300&fit=crop',
                 'https://images.unsplash.com/photo-1593642632823-8f785ba67e45?w=300&h=300&fit=crop',
                 'https://images.unsplash.com/photo-1527864550417-7fd91fc51a46?w=300&h=300&fit=crop&sat=-50',
                 'https://images.unsplash.com/photo-1615663245857-ac93bb7c39e7?w=300&h=300&fit=crop&sat=-30'
             ],
             'klavye': [
                 'https://images.unsplash.com/photo-1541140532154-b024d705b90a?w=300&h=300&fit=crop',
                 'https://images.unsplash.com/photo-1587829741301-dc798b83add3?w=300&h=300&fit=crop',
                 'https://images.unsplash.com/photo-1541140532154-b024d705b90a?w=300&h=300&fit=crop&sat=-20',
                 'https://images.unsplash.com/photo-1587829741301-dc798b83add3?w=300&h=300&fit=crop&sat=-40',
                 'https://images.unsplash.com/photo-1541140532154-b024d705b90a?w=300&h=300&fit=crop&sat=-60'
             ],
             'kulaklƒ±k': [
                 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=300&h=300&fit=crop',
                 'https://images.unsplash.com/photo-1484704849700-f032a568e944?w=300&h=300&fit=crop',
                 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=300&h=300&fit=crop&sat=-30',
                 'https://images.unsplash.com/photo-1484704849700-f032a568e944?w=300&h=300&fit=crop&sat=-50',
                 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=300&h=300&fit=crop&sat=-70'
             ],
             'laptop': [
                 'https://images.unsplash.com/photo-1496181133206-80ce9b88a853?w=300&h=300&fit=crop',
                 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=300&h=300&fit=crop',
                 'https://images.unsplash.com/photo-1496181133206-80ce9b88a853?w=300&h=300&fit=crop&sat=-20',
                 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=300&h=300&fit=crop&sat=-40',
                 'https://images.unsplash.com/photo-1496181133206-80ce9b88a853?w=300&h=300&fit=crop&sat=-60'
             ],
             'telefon': [
                 'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?w=300&h=300&fit=crop',
                 'https://images.unsplash.com/photo-1592750475338-74b7b21085ab?w=300&h=300&fit=crop',
                 'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?w=300&h=300&fit=crop&sat=-30',
                 'https://images.unsplash.com/photo-1592750475338-74b7b21085ab?w=300&h=300&fit=crop&sat=-50',
                 'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?w=300&h=300&fit=crop&sat=-70'
             ]
         }
         
         # Kategori i√ßin g√∂rselleri al
         images = product_images.get(category, [])
         
         # Eƒüer kategori i√ßin g√∂rsel yoksa, varsayƒ±lan g√∂rsel kullan
         if not images:
             return f'https://via.placeholder.com/300x300/2563eb/ffffff?text={category.title()}'
         
        # ƒ∞ndekse g√∂re g√∂rsel se√ß (d√∂ng√ºsel)
        return images[index % len(images)]
    
    def _get_search_url(self, category: str, index: int) -> str:
        """
        Amazon arama URL'leri d√∂nd√ºr√ºr.
           
           Args:
               category (str): √úr√ºn kategorisi
               index (int): √úr√ºn indeksi
               
           Returns:
               str: Amazon arama URL'i
           """
        # Kategori bazlƒ± √ºr√ºn adlarƒ±
        product_names = {
            'kulaklƒ±k': [
                'Anker Soundcore Liberty 4 NC',
                'Sony WF-C700N', 
                'Samsung Galaxy Buds FE',
                'Huawei FreeBuds 5i',
                'JBL Live Pro 2 TWS'
            ],
               'mouse': [
                   'Logitech G203 Lightsync Gaming Mouse',
                   'Razer DeathAdder V2 Gaming Mouse',
                   'SteelSeries Rival 3 Gaming Mouse',
                   'Corsair M65 RGB Elite Gaming Mouse',
                   'HyperX Pulsefire Haste Gaming Mouse'
               ],
               'klavye': [
                   'Logitech G Pro X Mechanical Gaming Keyboard',
                   'Razer BlackWidow V3 Pro Wireless Keyboard',
                   'SteelSeries Apex Pro TKL Gaming Keyboard',
                   'Corsair K100 RGB Mechanical Keyboard',
                   'HyperX Alloy Origins Core Gaming Keyboard'
               ]
           }
           
        # Kategori i√ßin √ºr√ºn adlarƒ±nƒ± al
        names = product_names.get(category, [])
        
        # Eƒüer kategori i√ßin √ºr√ºn adƒ± yoksa, genel arama yap
        if not names or index >= len(names):
            return f'https://www.amazon.com.tr/s?k={category}&i=electronics&rh=n%3A12466496031'
        
        # √úr√ºn adƒ±nƒ± al ve arama URL'i olu≈ütur
        product_name = names[index]
        search_query = product_name.replace(' ', '+')
        return f'https://www.amazon.com.tr/s?k={search_query}&i=electronics&rh=n%3A12466496031'
    
    def _get_mock_product_details(self, asin: str) -> Dict:
        """
        Mock √ºr√ºn detaylarƒ± d√∂nd√ºr√ºr.
        
        Args:
            asin (str): √úr√ºn ASIN'i
            
        Returns:
            Dict: Mock √ºr√ºn detaylarƒ±
        """
        return {
            'asin': asin,
            'title': f'Mock √úr√ºn - {asin}',
            'description': 'Bu bir √∂rnek √ºr√ºn a√ßƒ±klamasƒ±dƒ±r. Ger√ßek Amazon API anahtarƒ± ile ger√ßek veriler alabilirsiniz.',
            'price': {
                'current': 299.99,
                'currency': 'TRY',
                'original': 399.99
            },
            'rating': 4.5,
            'reviews_count': 250,
            'images': [
                'https://via.placeholder.com/500x500?text=√úr√ºn+G√∂rseli+1',
                'https://via.placeholder.com/500x500?text=√úr√ºn+G√∂rseli+2'
            ],
            'url': f'https://amazon.com.tr/dp/{asin}',
            'availability': 'Stokta',
            'prime': True,
            'features': [
                'Y√ºksek kalite',
                'Dayanƒ±klƒ± malzeme',
                'Kolay kullanƒ±m',
                'Uzun √∂m√ºrl√º'
            ],
            'specifications': [
                {'name': 'Marka', 'value': 'MockBrand'},
                {'name': 'Model', 'value': 'MockModel'},
                {'name': 'Renk', 'value': 'Siyah'},
                {'name': 'Aƒüƒ±rlƒ±k', 'value': '500g'}
            ],
            'reviews': [
                {
                    'rating': 5,
                    'title': 'Harika √ºr√ºn!',
                    'text': '√áok memnun kaldƒ±m, tavsiye ederim.',
                    'date': '2024-01-15'
                }
            ],
            'variants': [],
            'categories': ['Elektronik', 'Mock Kategori']
        } 